---
- name: Reboot
  ansible.builtin.command: "reboot &"
  async: 1
  poll: 0
  changed_when: true
  failed_when: false

- name: Wait for device to come back online
  ansible.builtin.wait_for_connection:
    timeout: 180
    delay: 10
  listen: Reboot

- name: Post reboot
  ansible.builtin.debug:
    msg: "Starting post-reboot tasks..."
  listen:
    - Reboot
    - Post reboot

- name: Wait for internet access # noqa: command-instead-of-module
  ansible.builtin.command:
    cmd: wget --timeout=5 --spider https://downloads.openwrt.org/releases/23.05.5/targets/x86/64/packages//Packages.gz
  changed_when: false
  register: _wget_packages_result
  retries: 12
  until: _wget_packages_result.rc == 0
  listen:
    - Reboot
    - Post reboot

- name: Update opkg cache
  opkg: # noqa: fqcn[action]
    name: opkg
    update_cache: true
  listen:
    - Reboot
    - Post reboot

- name: Install lsblk package
  community.general.opkg:
    name: lsblk
    state: present
  listen:
    - Reboot
    - Post reboot

- name: Get lsblk info
  ansible.builtin.command: lsblk -O -J -b
  register: lsblk_raw_output
  changed_when: false
  listen:
    - Reboot
    - Post reboot

- name: Parse lsblk JSON
  ansible.builtin.set_fact:
    lsblk_data: "{{ lsblk_raw_output.stdout | from_json }}"
  listen:
    - Reboot
    - Post reboot

- name: Identify the root disk object
  ansible.builtin.set_fact:
    # Find the top-level block device (type 'disk') that has a child partition mounted at '/'
    root_disk: >-
      {{ lsblk_data | json_query("blockdevices[?type == 'disk' && children[?mountpoint == '/']]") | first }}
  listen:
    - Reboot
    - Post reboot

- name: Identify the root partition object
  ansible.builtin.set_fact:
    # From the root disk's children, find the partition mounted at '/'
    root_partition: >-
      {{ (root_disk.children | default([])) | json_query("[?mountpoint == '/']") | first }}
  listen:
    - Reboot
    - Post reboot

- name: Set root disk partitions size
  ansible.builtin.set_fact:
    root_disk_partitions_size: "{{ root_disk.children | map(attribute='fssize', default=0) | select('number') | map('int') | sum }}"
  listen:
    - Reboot
    - Post reboot

- name: Set root disk unallocated space
  ansible.builtin.set_fact:
    root_disk_unallocated_space: "{{ root_disk.size | int - root_disk_partitions_size | int }}"
  listen:
    - Reboot
    - Post reboot

- name: Set root disk unallocated space percentage
  ansible.builtin.set_fact:
    root_disk_unallocated_space_percentage: "{{ (root_disk_unallocated_space | int / root_disk.size | int * 100) | round(2) }}"
  listen:
    - Reboot
    - Post reboot

- name: Set is free space
  ansible.builtin.set_fact:
    is_free_space: "{{ root_disk_unallocated_space_percentage | float > 3 }}"
  listen:
    - Reboot
    - Post reboot

- name: Debug identified root disk and partition details
  ansible.builtin.debug:
    msg: |
      --- Root Disk Details ---
      Name: {{ root_disk.name | default('N/A') }}
      Path: {{ root_disk.path | default('N/A') }}
      Size: {{ (root_disk.size | default(0) / (1024 * 1024 * 1024)) | round(2) }} GB

      --- Root Partition Details ---
      Name: {{ root_partition.name | default('N/A') }}
      Path: {{ root_partition.path | default('N/A') }}
      Size: {{ (root_partition.size | default(0) / (1024 * 1024)) | round(2) }} MB
      FS size: {{ (root_partition.fssize | default(0) / (1024 * 1024)) | round(2) }} MB
      Mountpoint: {{ root_partition.mountpoint | default('N/A') }}
      Partition Number (partn): {{ root_partition.partn | default('N/A') }}

      --- Unallocated Space Details ---
      Total size of filesystems on {{ root_disk.name }}: {{ (root_disk_partitions_size | int / (1024 * 1024 * 1024)) | round(2) }} GB
      Unallocated space on {{ root_disk.name }}: {{ (root_disk_unallocated_space | int / (1024 * 1024)) | round(2) }} MB
      Percentage of unallocated space on {{ root_disk.name }}: {{ (root_disk_unallocated_space_percentage | float) }}%
      Is there unallocated space? {{ root_disk_unallocated_space_percentage | float > 3 }}
  listen:
    - Reboot
    - Post reboot

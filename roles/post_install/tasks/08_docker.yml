---
- name: Install Docker packages
  community.general.opkg:
    name: "{{ item }}"
    state: present
  loop:
    - luci-app-dockerman
    - kmod-ipvlan
    - kmod-veth

- name: Remove Docker firewall configuration
  uci:
    command: absent
    config: dockerd
    section: firewall

- name: Remove Docker proxies configuration
  uci:
    command: absent
    config: dockerd
    section: proxies

- name: Disable Docker iptables
  uci:
    command: section
    config: dockerd
    type: globals
    name: globals
    value:
      ipv6: 1
      fixed_cidr_v6: 'fc00:1::/80'
      iptables: 0
      alt_config_file: /etc/docker/daemon.json
      data_root: /opt/docker/
      log_level: info
    replace: true

- name: Commit Docker UCI changes
  uci:
    command: commit
    config: dockerd
  notify: Reboot

- name: Create Docker data directory
  ansible.builtin.file:
    path: "{{ datadrive_mount_dir }}/docker"
    state: directory
    mode: '0755'

- name: Verify Docker configuration
  ansible.builtin.command: docker info
  register: docker_info
  changed_when: false

- name: Display Docker data root
  ansible.builtin.debug:
    msg: "Docker data root: {{ docker_info.stdout | regex_search('Docker Root Dir: (.+)', '\\1') | first }}"

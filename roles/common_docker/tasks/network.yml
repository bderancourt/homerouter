---
- name: Create virtual ethernet device for Docker isolation
  uci:
    command: section
    config: network
    type: device
    find-by:
      name: "{{ host_interface }}"
    value:
      type: veth
      peer_name: "{{ docker_interface }}"

- name: "Create network interface {{ service }}"
  uci:
    command: section
    config: network
    type: interface
    name: "{{ service }}"
    value:
      device: "{{ host_interface }}"
      proto: static
      ipaddr: "{{ gateway_ipv4 }}"
      netmask: "{{ netmask }}"
      ip6hint: "{{ vlan_id }}"
      ip6assign: 64

- name: Commit network changes
  uci:
    command: commit
    config: network
  notify: Reload config

- name: Flush handlers
  ansible.builtin.meta: flush_handlers

- name: restart network to apply Docker network changes
  ansible.builtin.service:
    name: network
    state: restarted

#!/bin/sh
set -x

# https://openwrt.org/docs/guide-user/advanced/expand_root?s[]=resize#instructions_manual
# OpenWrt 24.10+ uses ext4 directly without overlay/loop devices

# Redirect debug output to log file
{
    [ -e /etc/rootfs-resize-ok ] && exit 0
    [ ! -e /etc/rootpt-resize-ok ] && exit 1
    [ ! -e /etc/rootfs-repair-ok ] && exit 1

    lock -n /var/lock/root-resize
    ROOT_BLK="$(readlink -f /sys/dev/block/"$(awk -e '$9=="/dev/root"{print $3}' /proc/self/mountinfo)")"
    ROOT_PART="/dev/${ROOT_BLK##*/}"

    # Resize the ext4 filesystem to match partition size (online resize)
    resize2fs "${ROOT_PART}"
    tune2fs -Oresize_inode "${ROOT_PART}"

    touch /etc/rootfs-resize-ok
} > /var/log/rootfs-resize 2>&1

reboot

---
- name: Install block-mount package
  community.general.opkg:
    name: block-mount
    state: present
    update_cache: true


- name: Create datadrive mount directory
  ansible.builtin.file:
    path: "{{ datadrive_mount_dir }}"
    state: directory
    mode: '0755'


- name: Find UUID of partition labeled 'data'
  ansible.builtin.shell: set -o pipefail && lsblk -n -o UUID,LABEL | awk '$2=="data" {print $1}'
  register: data_uuid_result
  changed_when: false
  failed_when: false


- name: Set data partition UUID
  ansible.builtin.set_fact:
    data_uuid: "{{ data_uuid_result.stdout | trim }}"


- name: Configure fstab mount for data partition
  uci:
    command: section
    config: fstab
    type: mount
    find-by:
      uuid: "{{ data_uuid }}"
    value:
      target: "{{ datadrive_mount_dir }}"
      enabled: '1'
  notify: Reboot


- name: Commit fstab changes
  uci:
    command: commit
    config: fstab


- name: Trigger reboot
  ansible.builtin.meta: flush_handlers


- name: Verify data partition mount - Get mount info
  ansible.builtin.command: lsblk -J -o NAME,LABEL,MOUNTPOINT,UUID
  register: lsblk_mount_verify
  changed_when: false


- name: Verify data partition mount - Parse JSON
  ansible.builtin.set_fact:
    lsblk_mount_data: "{{ lsblk_mount_verify.stdout | from_json }}"


- name: Verify data partition mount - Find data partition
  ansible.builtin.set_fact:
    data_partition_mount: >-
      {{ lsblk_mount_data | json_query('blockdevices[].children[?label==`data`].mountpoint') | flatten | first | default('') }}


- name: Verify data partition mount - Display result
  ansible.builtin.debug:
    msg: |
      --- Data Partition Mount Verification ---
      Expected mount point: {{ datadrive_mount_dir }}
      Actual mount point: {{ data_partition_mount | default('Not mounted') }}

      âœ“ Data partition correctly mounted: {{ data_partition_mount == datadrive_mount_dir }}

---
- name: Run post reboot
  ansible.builtin.import_role:
    name: common_post_reboot

- name: Fetch latest packages from fantastic-packages
  ansible.builtin.uri:
    url: "{{ fantastic_packages_base_url }}"
    method: GET
    return_content: true
  register: fantastic_packages_page
  changed_when: false

- name: Define desired luci packages
  ansible.builtin.set_fact:
    desired_luci_packages:
      - luci-app-temp-status
      - luci-app-disks-info
      - luci-app-cpu-perf
      - luci-app-cpu-status-mini

- name: Build package dicts with pkg key
  ansible.builtin.set_fact:
    pkg_dicts: "{{ desired_luci_packages | map('community.general.dict_kv', 'pkg') }}"
  changed_when: false

- name: Build list of versioned packages from fantastic-packages page
  ansible.builtin.set_fact:
    packages_versionned: >-
      {{ packages_versionned | default([]) + [ fantastic_packages_page.content | regex_search( '[^\"]*' ~ item ~ '[^\"]*\.ipk' ) ] }}
  loop: "{{ desired_luci_packages }}"
  changed_when: false

- name: Build package URLs from versioned packages
  ansible.builtin.set_fact:
    packages_urls: "{{ packages_versionned | map('regex_replace', '^', fantastic_packages_base_url) }}"
  changed_when: false

- name: Build package dicts with url key
  ansible.builtin.set_fact:
    url_dicts: "{{ packages_urls | map('community.general.dict_kv', 'url') }}"
  changed_when: false

- name: Combine pkg and url dicts
  ansible.builtin.set_fact:
    packages_dict: "{{ pkg_dicts | zip(url_dicts) | map('combine') }}"
  changed_when: false

- name: Install LuCI packages via include_tasks
  ansible.builtin.include_tasks:
    file: install_opkg_package.yml
  loop: "{{ packages_dict }}"

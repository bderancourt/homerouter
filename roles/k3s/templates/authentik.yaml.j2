apiVersion: v1
kind: Namespace
metadata:
  name: authentik
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: authentik
  namespace: kube-system
spec:
  repo: https://charts.goauthentik.io
  chart: authentik
  targetNamespace: authentik
  createNamespace: true
  valuesContent: |-
    authentik:
      secret_key: "changeme_please_to_something_secure_and_long_enough"
      postgresql:
        password: "authentik_db_password"
    
    postgresql:
      enabled: true
      auth:
        password: "authentik_db_password"
        username: "authentik"
        database: "authentik"
      primary:
        persistence:
          enabled: false
    
    redis:
      enabled: true
      auth:
        enabled: false
      master:
        persistence:
          enabled: false
    
    server:
      ingress:
        enabled: true
        hosts:
          - auth.{{ domain }}
        paths:
          - /
        pathType: Prefix
      # Increase timeouts to allow for migrations/lock acquisition
      readinessProbe:
        initialDelaySeconds: 60
        periodSeconds: 10
        failureThreshold: 30
        timeoutSeconds: 5
      livenessProbe:
        initialDelaySeconds: 60
        periodSeconds: 10
        failureThreshold: 30
        timeoutSeconds: 5
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: authentik
  namespace: authentik
spec:
  forwardAuth:
    address: http://authentik-server.authentik.svc.cluster.local/outpost.goauthentik.io/auth/traefik
    trustForwardHeader: true
    authResponseHeaders:
      - X-authentik-username
      - X-authentik-groups
      - X-authentik-email
      - X-authentik-name
      - X-authentik-uid
      - X-authentik-jwt
      - X-authentik-meta-jwks
      - X-authentik-meta-outpost
      - X-authentik-meta-provider
      - X-authentik-meta-app
      - X-authentik-meta-version

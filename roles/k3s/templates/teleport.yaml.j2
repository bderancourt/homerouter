apiVersion: v1
kind: Namespace
metadata:
  name: teleport
---
# NetworkPolicy: Allow intra-namespace traffic
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-same-namespace
  namespace: teleport
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector: {}
  egress:
  - to:
    - podSelector: {}
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
---
# NetworkPolicy: Allow ingress from Traefik
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-from-traefik
  namespace: teleport
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: teleport
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
      podSelector:
        matchLabels:
          app.kubernetes.io/name: traefik
    ports:
    - protocol: TCP
      port: 443
---
# NetworkPolicy: Allow email plugin to reach SMTP and internet
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-email-plugin-egress
  namespace: teleport
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: teleport-plugin-email
  policyTypes:
  - Egress
  egress:
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  # Allow connection to Teleport auth
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: teleport
    ports:
    - protocol: TCP
      port: 3025
  # Allow SMTP (port 587)
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
    ports:
    - protocol: TCP
      port: 587
---
# NetworkPolicy: Allow email plugin ingress to Teleport auth
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-email-plugin-to-auth
  namespace: teleport
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: teleport
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: teleport-plugin-email
    ports:
    - protocol: TCP
      port: 3025
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: teleport
  namespace: kube-system
spec:
  repo: https://charts.releases.teleport.dev
  chart: teleport-cluster
  targetNamespace: teleport
  createNamespace: false
  valuesContent: |-
    clusterName: "bastion.{{ domain }}"
    
    # Use separate listener mode for TLS termination by Traefik
    proxyListenerMode: separate
    
    # Disable TLS verification for connections behind Traefik
    extraArgs:
      - "--insecure"
    
    proxy:
      service:
        type: ClusterIP
    
    ingress:
      enabled: false

    persistence:
      enabled: false
---
# IngressRoute for Teleport Web UI with TLS termination by Traefik
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: teleport-web
  namespace: teleport
spec:
  entryPoints:
    - websecure
    - websecext
  routes:
    - match: Host(`bastion.{{ domain }}`)
      kind: Rule
      services:
        - name: teleport
          port: 443
          scheme: https
          serversTransport: teleport-transport
  tls: {}
---
# ServersTransport for Teleport (self-signed cert on backend)
apiVersion: traefik.io/v1alpha1
kind: ServersTransport
metadata:
  name: teleport-transport
  namespace: teleport
spec:
  insecureSkipVerify: true
---
# HelmChart for Teleport Email Plugin
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: teleport-plugin-email
  namespace: kube-system
spec:
  repo: https://charts.releases.teleport.dev
  chart: teleport-plugin-email
  version: 18.5.1
  targetNamespace: teleport
  createNamespace: false
  valuesContent: |-
    smtp:
      enabled: true
      host: "{{ smtp_host }}"
      port: 587
      username: "{{ smtp_username }}"
      password: {{ smtp_password | to_json }}
      starttlsPolicy: "mandatory"
    
    delivery:
      sender: "teleport@{{ domain }}"
    
    roleToRecipients:
      "*":
        - "{{ acme_email }}"
    
    tbot:
      enabled: true
      # Connect directly to auth service (internal connection)
      teleportAuthAddress: "teleport-auth.teleport.svc.cluster.local:3025"
      joinMethod: kubernetes
      token: email-plugin-bot
      roles:
        - access-plugin
      # Disable default output to avoid proxy pinging
      defaultOutput:
        enabled: false
    
    log:
      severity: INFO

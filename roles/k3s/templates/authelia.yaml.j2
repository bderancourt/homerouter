apiVersion: v1
kind: Namespace
metadata:
  name: authelia
---
# NetworkPolicy: Allow intra-namespace traffic, deny inter-namespace by default
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-same-namespace
  namespace: authelia
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow all traffic from same namespace
  - from:
    - podSelector: {}
  egress:
  # Allow all traffic to same namespace
  - to:
    - podSelector: {}
  # Allow DNS to kube-system
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
---
# NetworkPolicy: Allow ingress from Traefik to authelia
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-from-traefik
  namespace: authelia
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: authelia
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
      podSelector:
        matchLabels:
          app.kubernetes.io/name: traefik
    ports:
    - protocol: TCP
      port: 9091
---
# NetworkPolicy: Allow egress to internet for SMTP
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-egress-internet
  namespace: authelia
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: authelia
  policyTypes:
  - Egress
  egress:
  # Allow HTTPS
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443
  # Allow SMTP (port 465 SSL/TLS, 587 STARTTLS)
  - ports:
    - protocol: TCP
      port: 465
    - protocol: TCP
      port: 587

---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: authelia
  namespace: kube-system
spec:
  repo: https://charts.authelia.com
  chart: authelia
  version: 0.10.49
  targetNamespace: authelia
  createNamespace: false
  valuesContent: |-
    ingress:
      enabled: true
      annotations:
        traefik.ingress.kubernetes.io/router.entrypoints: websecure,websecext
        traefik.ingress.kubernetes.io/router.tls: "true"
      tls:
        enabled: false
      traefikCRD:
        enabled: true
        disableIngressRoute: true
        entryPoints:
          - websecure
          - websecext
    
    pod:
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 256Mi
    
    configMap:
      theme: auto
      default_2fa_method: totp
      
      log:
        level: info
      
      totp:
        issuer: {{ domain }}
      
      authentication_backend:
        file:
          enabled: true
          password:
            algorithm: argon2
      
      access_control:
        default_policy: deny
        rules:
          - domain: "*.{{ domain }}"
            policy: two_factor
      
      session:
        encryption_key:
          value: {{ authelia_session_secret | to_json }}
        cookies:
          - domain: {{ domain }}
            subdomain: auth
            default_redirection_url: https://{{ domain }}
        expiration: 1h
        inactivity: 5m
        remember_me: 1M
      
      regulation:
        max_retries: 3
        find_time: 2m
        ban_time: 5m
      
      storage:
        encryption_key:
          value: {{ authelia_storage_encryption_key | to_json }}
        local:
          enabled: true
      
      notifier:
        smtp:
          enabled: true
          address: submissions://{{ smtp_host | default('localhost') }}:465
          username: {{ smtp_username | default('') }}
          sender: authelia@{{ domain }}
          subject: "[Authelia] {title}"
          startup_check_address: test@authelia.com
          password:
            value: {{ smtp_password | default('') | to_json }}
          tls:
            server_name: {{ smtp_host | default('localhost') }}
    
    persistence:
      enabled: false

---
apiVersion: v1
kind: Secret
metadata:
  name: authelia-users
  namespace: authelia
type: Opaque
stringData:
  users.yaml: |
    users:
      admin:
        displayname: "Admin User"
        password: "{{ authelia_admin_password }}"
        email: admin@{{ domain }}
        groups:
          - admins
          - dev

---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: authelia
  namespace: authelia
spec:
  forwardAuth:
    address: http://authelia.authelia.svc.cluster.local:9091/api/authz/forward-auth
    trustForwardHeader: true
    authResponseHeaders:
      - Remote-User
      - Remote-Groups
      - Remote-Name
      - Remote-Email

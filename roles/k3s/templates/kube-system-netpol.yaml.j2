---
# NetworkPolicy: Allow CoreDNS ingress
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-coredns-ingress
  namespace: kube-system
spec:
  podSelector:
    matchLabels:
      k8s-app: kube-dns
  policyTypes:
  - Ingress
  ingress:
  # Allow DNS queries from all pods
  - from:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
---
# NetworkPolicy: Allow CoreDNS egress
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-coredns-egress
  namespace: kube-system
spec:
  podSelector:
    matchLabels:
      k8s-app: kube-dns
  policyTypes:
  - Egress
  egress:
  # Allow DNS forwarding to host DNS (192.168.4.1)
  - to:
    - ipBlock:
        cidr: 192.168.{{ k3s_admin_subnet_id }}.1/32
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  # Allow queries to other nameservers (fallback)
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
---
# NetworkPolicy: Allow Traefik ingress
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-traefik-ingress
  namespace: kube-system
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: traefik
  policyTypes:
  - Ingress
  ingress:
  # Allow HTTP/HTTPS from anywhere (hostNetwork so external traffic)
  - ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 8443
    - protocol: TCP
      port: 9100
---
# NetworkPolicy: Allow Traefik egress
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-traefik-egress
  namespace: kube-system
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: traefik
  policyTypes:
  - Egress
  egress:
  # Allow DNS
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53
  # Allow to all pods (reverse proxy needs to reach all services)
  - to:
    - namespaceSelector: {}
  # Allow Kubernetes API for service discovery
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: default
    ports:
    - protocol: TCP
      port: 6443
  # Allow ACME HTTP-01 challenge
  - ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443
---
# NetworkPolicy: Allow metrics-server egress
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-metrics-server-egress
  namespace: kube-system
spec:
  podSelector:
    matchLabels:
      k8s-app: metrics-server
  policyTypes:
  - Egress
  egress:
  # Allow DNS
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53
  # Allow Kubernetes API
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: default
    ports:
    - protocol: TCP
      port: 6443
  # Allow kubelet metrics (all nodes)
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 10250

---
- name: Install firmware, download firmware
  ansible.builtin.get_url:
    url: "{{ firmware_url }}"
    dest: "/tmp/{{ firmware_url | basename }}"
    checksum: "{{ firmware_checksum }}"
    mode: u=rw,g=r,o=r
  delegate_to: 127.0.0.1
  become: false

- name: Install firmware, copy image to router
  ansible.builtin.copy:
    src: "/tmp/{{ firmware_url | basename }}"
    dest: /tmp/openwrt.img.gz
    mode: u=rw,g=r,o=r

- name: Install firmware, start sysupgrade process
  nohup:
    command: sysupgrade -n /tmp/openwrt.img.gz

- name: Wait for connection
  ansible.builtin.wait_for_connection:
    timeout: 300
    delay: 10

# Minimal configuration to have internet after upgrade with my ISP
- name: Install firmware, uci set wan vendorid option
  uci:
    command: section
    config: network
    type: interface
    name: wan
    value:
      vendorid: neufbox_NB6VAC-directAccess

- name: Install firmware, commit
  ansible.builtin.include_tasks: commit.yml
  loop:
    - network

# Needed to update opkg and ensure mandatory packages for
# ekmihesg.openwrt role to work are installed
- name: Install firmware, re-install gekmihesg.openwrt role
  ansible.builtin.include_role:
    name: gekmihesg.openwrt
  vars:
    openwrt_install_recommended_packages: true
